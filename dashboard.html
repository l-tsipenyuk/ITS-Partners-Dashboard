<!DOCTYPE html>
<html>
<head>
    <title>ITS Partners Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary-green: #00A651;
            --secondary-yellow: #FFD100;
            --accent-blue: #00A9E0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logos-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .partner-logo {
            width: 140px;
            height: 110px;
            object-fit: contain;
            display: none; /* Hidden by default */
        }

        .logo {
            width: 150px;
            height: auto;
        }

        .upload-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .toggle-upload {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .toggle-upload:hover {
        background: #e9e9e9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .file-upload {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .file-upload input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 150px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-card.clickable {
            cursor: pointer;
        }

        .metric-card.non-clickable {
            cursor: default;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-green);
        }

        .metric-label {
            color: #666;
            margin-top: 5px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 300px;
        }

        .chart-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-green);
        }

        .startup-table, .reports-table, .activities-table {
            height: 250px;
            overflow-y: auto;
            width: 100%;
            margin-top: 15px;
        }

        .activities-table td.description {
            max-width: 400px;
            white-space: normal;
            word-wrap: break-word;
            padding: 12px 8px;
        }

        .activities-table td {
            padding: 12px 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 1200px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }


#engagedStartupsModal th:nth-child(1), /* Startup */
#engagedStartupsModal td:nth-child(1) {
    width: 15%;
    min-width: 120px;
}

#engagedStartupsModal th:nth-child(2), /* Partner */
#engagedStartupsModal td:nth-child(2) {
    width: 10%;
    min-width: 80px;
}

#engagedStartupsModal th:nth-child(3), /* Category */
#engagedStartupsModal td:nth-child(3) {
    width: 12%;
    min-width: 100px;
}

#engagedStartupsModal th:nth-child(4), /* Funding Stage */
#engagedStartupsModal td:nth-child(4) {
    width: 12%;
    min-width: 100px;
}

#engagedStartupsModal th:nth-child(5), /* Contact */
#engagedStartupsModal td:nth-child(5) {
    width: 15%;
    min-width: 120px;
}

#engagedStartupsModal th:last-child, /* Comment */
#engagedStartupsModal td:last-child {
    width: 36%;
    min-width: 200px;
}

#engagedStartupsModal table {
    width: 100%;
    table-layout: fixed;
}

#engagedStartupsModal td, 
#engagedStartupsModal th {
    padding: 12px 8px;
    vertical-align: top;
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Ensure the modal content doesn't overflow horizontally */
#engagedStartupsModal .modal-content {
    overflow-x: hidden;
}

        .close {
            float: right;
            cursor: pointer;
            font-size: 20px;
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .reports-table td.description {
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }
        
        /* Style for clickable links */
        .contact-link {
            color: #00A651;
            text-decoration: underline;
            cursor: pointer;
        }

        .modal table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .modal th, .modal td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .modal th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .modal td.description {
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }     
        
        .contacted-row {
            background-color: #e6ffe6; /* Light green background */
        }

        .contacted-row:hover {
            background-color: #ccffcc; /* Slightly darker green on hover */
        }
        
    </style>
</head>
<body>
    <div class="header-section">
        <h1>ITS Partners Analytics Dashboard</h1>
        <div class="logos-container">
            <!-- Partner logos -->
            <img src="./eon_logo.png" alt="E.ON Logo" class="partner-logo" id="eon-logo" />
            <img src="./tadiran_logo.png" alt="Tadiran Logo" class="partner-logo" id="tadiran-logo" />
            <img src="./iec_logo.png" alt="IEC Logo" class="partner-logo" id="iec-logo" />
            <!-- ITS Logo -->
            <img src="./logo.png" alt="Ignite The Spark" class="logo">
        </div>
    </div>
    
    <div class="upload-section" id="uploadSection">
        <div class="file-upload">
            <input type="file" id="csvFile" accept=".csv" />
            <select id="partnerFilter">
                <option value="all">All Partners</option>
            </select>
        </div>
        <p>Please upload your CSV file with the following columns: Partner, Report, Date, Startup, Category, Stage, Country, Contact, Engaged, Link, Engagement</p>
    </div>

    <button class="toggle-upload" onclick="toggleUploadSection()">Hide Upload Section</button>

    <div id="loading" class="loading">
        Loading data...
    </div>

    <div class="filters">
        <div>
            <label for="reportFilter">Report:</label>
            <select id="reportFilter">
                <option value="all">All Reports</option>
            </select>
        </div>
    </div>

    <div class="metrics">
        <div class="metric-card non-clickable">
            <div class="metric-value" id="totalStartups">0</div>
            <div class="metric-label">Total Startups</div>
        </div>
        <div class="metric-card clickable" onclick="showEngagedStartupsModal()">
            <div class="metric-value" id="engagedStartups">0</div>
            <div class="metric-label">Engaged Startups (Click for details)</div>
        </div>
        <div class="metric-card clickable" onclick="showActivitiesModal()">
            <div class="metric-value" id="totalActivities">0</div>
            <div class="metric-label">Engagement Activities (Click for details)</div>
        </div>
        <div class="metric-card clickable" onclick="showReportsModal()">
            <div class="metric-value" id="totalReports">0</div>
            <div class="metric-label">Total Reports (Click for details)</div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="stageChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="countryChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="startup-table">
                <table>
                    <thead>
                        <tr>
                            <th>Startup</th>
                            <th>Category</th>
                            <th>Funding Stage</th>
                            <th>Contact</th>
                        </tr>
                    </thead>
                    <tbody id="startupTableBody">
                    </tbody>
                </table>
            </div>
        </div>

    <div id="reportsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideReportsModal()">&times;</span>
            <h2>Reports Details</h2>
            <table>
                <thead>
                    <tr>
                        <th>Report</th>
                        <th>Partner</th>
                        <th>Date</th>
                        <th>Total Startups</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <div id="activitiesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideActivitiesModal()">&times;</span>
            <h2>Engagement Activities</h2>
            <table class="activities-table">
                <thead>
                    <tr>
                        <th>Activity</th>
                        <th>Partner</th>
                        <th>Date</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="activitiesTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <div id="engagedStartupsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideEngagedStartupsModal()">&times;</span>
            <h2>Engaged Startups Details</h2>
            <table>
                <thead>
                    <tr>
                        <th>Startup</th>
                        <th>Partner</th>
                        <th>Category</th>
                        <th>Funding Stage</th>
                        <th>Contact</th>
                        <th>Comment</th>
                    </tr>
                </thead>
                <tbody id="engagedStartupsTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let data = [];
        let categoryChart, stageChart, countryChart;

        const chartColors = [
            '#00A651', // Primary green
            '#FFD100', // Yellow
            '#00A9E0', // Blue
            '#007B3C', // Darker green
            '#FFE666', // Lighter yellow
            '#66D1FF', // Lighter blue
            '#004D25', // Darkest green
            '#B39400', // Darker yellow
            '#007AA3'  // Darker blue
        ];

        function toggleUploadSection() {
            const section = document.getElementById('uploadSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        // Initialize charts
        function initCharts() {
            if (categoryChart) categoryChart.destroy();
            if (stageChart) stageChart.destroy();
            if (countryChart) countryChart.destroy();
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        font: {
                            size: 20,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        position: 'right'
                    }
                }
            };

            categoryChart = createPieChart('categoryChart', [], [], 'Startups by Category', chartOptions);
            stageChart = createPieChart('stageChart', [], [], 'Startups by Funding Stage', chartOptions);
            countryChart = createPieChart('countryChart', [], [], 'Startups by Country', chartOptions);
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    
    document.getElementById('loading').style.display = 'block';
    
    reader.onload = function(event) {
        try {
            const csvData = event.target.result;
            
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: 'greedy',
                delimitersToGuess: [',', '\t', '|', ';'],
                transformHeader: h => h.trim(),
                complete: function(results) {
                    try {
                        data = results.data
                            .filter(row => row.Partner && row.Report)
                            .map(row => {
                                return {
                                    partner: row.Partner || '',
                                    quarter: row.Report || '',
                                    date: row.Date || '',
                                    startup: (row.Startup || '').trim(),
                                    category: row.Category || '',
                                    stage: row.Stage || '',
                                    country: row.Country || '',
                                    contact: row.Contact || '',
                                    engaged: row.Engaged || '',
                                    link: row.Link || '',
                                    engagement: row.Engagement || '',
                                    comments: row['Comment'] || row['Comment '] || ''
                                };
                            });

                        updateFilters();
                        initCharts();
                        updateDashboard();
                        
                    } catch (error) {
                        console.error('Error in data processing:', error);
                        alert('Error processing the data. Please check the console for details.');
                    }
                },
                error: function(error) {
                    console.error('PapaParse Error:', error);
                    alert('Error parsing the CSV file. Please check the format.');
                }
            });
            
        } catch (error) {
            console.error('Error in file reading:', error);
            alert('Error reading the file. Please try again.');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    };
    
    reader.onerror = function(error) {
        console.error('FileReader Error:', error);
        document.getElementById('loading').style.display = 'none';
        alert('Error reading the file. Please try again.');
    };
    
    reader.readAsText(file);
});

    function processChartData(data, minCategories) {
        // Sort entries by value in descending order
        const sortedEntries = Object.entries(data).sort((a, b) => b[1] - a[1]);
        
        const mainCategories = {};
        let otherSum = 0;
        
        sortedEntries.forEach(([key, value], index) => {
            if (index < minCategories) {
                // Always include top N categories
                mainCategories[key] = value;
            } else {
                otherSum += value;
            }
        });
        
        if (otherSum > 0) {
            mainCategories['Other'] = otherSum;
        }
        
        return mainCategories;
    }

    function showEngagedStartupsModal() {
    const selectedPartner = document.getElementById('partnerFilter').value;
    document.getElementById('engagedStartupsModal').style.display = 'flex';
    updateEngagedStartupsTable(selectedPartner);
}


    function hideEngagedStartupsModal() {
        document.getElementById('engagedStartupsModal').style.display = 'none';
    }

    function updateEngagedStartupsTable(selectedPartner) {
    const tableBody = document.getElementById('engagedStartupsTableBody');
    tableBody.innerHTML = '';
    
    const engagedStartups = data.filter(item => 
        item.startup && 
        item.startup.trim() !== '' &&
        item.engaged?.toLowerCase() === 'yes' &&
        (selectedPartner === 'all' || item.partner === selectedPartner)
    );
    
    // Sort the array to have contacted startups first
    const sortedStartups = engagedStartups.sort((a, b) => {
        // Sort by engagement status (Contacted first)
        const aContacted = a.engagement === 'Contacted';
        const bContacted = b.engagement === 'Contacted';
        
        if (aContacted && !bContacted) return -1;
        if (!aContacted && bContacted) return 1;
        
        // If engagement status is the same, sort by date (newest first)
        if (a.date && b.date) {
            return new Date(b.date) - new Date(a.date);
        }
        return 0;
    });
    
    sortedStartups.forEach(item => {
        const row = tableBody.insertRow();
        
        // Add the contacted-row class if engagement is "Contacted"
        if (item.engagement === 'Contacted') {
            row.classList.add('contacted-row');
        }
        
        const nameCell = row.insertCell(0);
        const nameLink = document.createElement('a');
        if (item.link && item.link.trim()) {
            nameLink.href = item.link;
        } else {
            nameLink.href = `https://www.google.com/search?q=${encodeURIComponent(item.startup)}`;
        }
        nameLink.textContent = item.startup;
        nameLink.className = 'startup-link';
        nameLink.target = '_blank';
        nameCell.appendChild(nameLink);
        
        row.insertCell(1).textContent = item.partner;
        row.insertCell(2).textContent = item.category;
        row.insertCell(3).textContent = item.stage;
        
        const contactCell = row.insertCell(4);
        if (item.contact && item.contact.toLowerCase().startsWith('http')) {
            const contactLink = document.createElement('a');
            contactLink.href = item.contact;
            contactLink.textContent = item.contact;
            contactLink.className = 'contact-link';
            contactLink.target = '_blank';
            contactCell.appendChild(contactLink);
        } else {
            contactCell.textContent = item.contact;
        }
        
        row.insertCell(5).textContent = item.comments || '';
    });
}

function updateDashboard() {
    const selectedPartner = document.getElementById('partnerFilter').value;
    const reportFilter = document.getElementById('reportFilter').value;
    
    // Calculate engagement activities
    const activitiesCount = data.filter(item => 
        item.quarter === 'Engagement Activity' &&
        (selectedPartner === 'all' || item.partner === selectedPartner)
    ).length;
    document.getElementById('totalActivities').textContent = activitiesCount;

    // Calculate engaged startups
    const engagedStartups = data.filter(item => 
        item.startup && 
        item.startup.trim() !== '' &&
        item.engaged?.toLowerCase() === 'yes' &&
        (selectedPartner === 'all' || item.partner === selectedPartner)
    );
    document.getElementById('engagedStartups').textContent = engagedStartups.length;

    // Filter data
    const filteredData = data.filter(item => {
        const partnerMatch = selectedPartner === 'all' || item.partner === selectedPartner;
        const isNotMatched = item.quarter !== 'Matched Startup';
        const isNotActivity = item.quarter !== 'Engagement Activity';
        const hasStartup = item.startup && item.startup.trim() !== '';
        return partnerMatch && isNotMatched && isNotActivity && hasStartup;
    });

    // Apply report filter
    const reportFilteredData = filteredData.filter(item => 
        reportFilter === 'all' || item.quarter === reportFilter
    );
    document.getElementById('totalStartups').textContent = reportFilteredData.length;

    // Calculate total reports
    const uniqueReports = new Set(
        data
            .filter(item => 
                (selectedPartner === 'all' || item.partner === selectedPartner) &&
                item.quarter !== 'Engagement Activity' &&
                item.quarter !== 'Matched Startup'
            )
            .map(item => item.quarter)
    );
    document.getElementById('totalReports').textContent = uniqueReports.size;

    updateTable(reportFilteredData);
    updateCharts(reportFilteredData);
    updateReportsTable(filteredData);
}


function updatePartnerLogo(selectedPartner) {
            // Hide all partner logos first
            document.querySelectorAll('.partner-logo').forEach(logo => {
                logo.style.display = 'none';
            });

            // Show the selected partner's logo
            if (selectedPartner !== 'all') {
                const logoMap = {
                    'E.ON': 'eon-logo',
                    'Tadiran': 'tadiran-logo',
                    'IEC': 'iec-logo'
                };

                const logoId = logoMap[selectedPartner];
                if (logoId) {
                    document.getElementById(logoId).style.display = 'block';
                }
            }
        }

        // Modify the existing partner filter event listener
        document.getElementById('partnerFilter').addEventListener('change', (e) => {
            updatePartnerLogo(e.target.value);
            updateReportFilter();
            updateDashboard();
        });

        function updateTable(filteredData) {
    const tableBody = document.getElementById('startupTableBody');
    tableBody.innerHTML = '';
    
    const validData = filteredData.filter(item => item.startup && item.startup.trim() !== '');
    
    validData.forEach(item => {
        const row = tableBody.insertRow();
        
        const nameCell = row.insertCell(0);
        const nameLink = document.createElement('a');
        
        if (item.link && item.link.trim() !== '') {
            nameLink.href = item.link;
        } else {
            nameLink.href = `https://www.google.com/search?q=${encodeURIComponent(item.startup)}`;
        }
        
        nameLink.textContent = item.startup;
        nameLink.className = 'startup-link';
        nameLink.target = '_blank';
        nameLink.title = item.link ? item.link : 'Search on Google';
        
        nameCell.appendChild(nameLink);
        
        row.insertCell(1).textContent = item.category;
        row.insertCell(2).textContent = item.stage;
        
        const contactCell = row.insertCell(3);
        if (item.contact && item.contact.toLowerCase().startsWith('http')) {
            const contactLink = document.createElement('a');
            contactLink.href = item.contact;
            contactLink.textContent = item.contact;
            contactLink.className = 'contact-link';
            contactLink.target = '_blank';
            contactCell.appendChild(contactLink);
        } else {
            contactCell.textContent = item.contact;
        }
    });
}

        function updateFilters() {
    // Update partner filter
    const partners = [...new Set(data.map(item => item.partner))].sort();
    const partnerFilter = document.getElementById('partnerFilter');
    partnerFilter.innerHTML = '<option value="all">All Partners</option>';
    partners.forEach(partner => {
        const option = document.createElement('option');
        option.value = partner;
        option.textContent = partner;
        partnerFilter.appendChild(option);
    });

    updateReportFilter();
}

function updateReportFilter() {
    const selectedPartner = document.getElementById('partnerFilter').value;
    const reportFilter = document.getElementById('reportFilter');
    
    const reportInfo = {};
    data
        .filter(item => 
            item.quarter !== 'Engagement Activity' && 
            item.quarter !== 'Matched Startup' &&
            item.startup && 
            item.startup.trim() !== ''
        )
        .forEach(item => {
            if (selectedPartner === 'all' || item.partner === selectedPartner) {
                if (!reportInfo[item.quarter]) {
                    reportInfo[item.quarter] = {
                        count: 0,
                        date: item.date
                    };
                }
                reportInfo[item.quarter].count++;
            }
        });
    
    const relevantReports = Object.entries(reportInfo)
        .filter(([_, info]) => info.count > 0)
        .sort((a, b) => {
            const dateA = new Date(a[1].date);
            const dateB = new Date(b[1].date);
            return dateB - dateA;
        })
        .map(([report]) => report);
    
    reportFilter.innerHTML = '<option value="all">All Reports</option>';
    relevantReports.forEach(report => {
        const option = document.createElement('option');
        option.value = report;
        option.textContent = report;
        reportFilter.appendChild(option);
    });
}


        document.getElementById('partnerFilter').addEventListener('change', () => {
            updateReportFilter(); // Update report filter first
            updateDashboard(); // Then update dashboard
        });

        document.getElementById('reportFilter').addEventListener('change', updateDashboard);

        function createPieChart(canvasId, data, labels, title, options) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: chartColors
                    }]
                },
                options: {
                    ...options,
                    plugins: {
                        ...options.plugins,
                        title: {
                            ...options.plugins.title,
                            text: title
                        }
                    }
                }
            });
        }

        function updateCharts(filteredData) {
    // Update category chart
    const categories = {};
    filteredData
        .filter(item => item.startup && item.startup.trim() !== '')
        .forEach(item => {
            categories[item.category] = (categories[item.category] || 0) + 1;
        });
    
    const processedCategories = processChartData(categories, 7);
    categoryChart.data.labels = Object.keys(processedCategories);
    categoryChart.data.datasets[0].data = Object.values(processedCategories);
    categoryChart.update();

    // Update stage chart
    const stages = {};
    filteredData
        .filter(item => item.startup && item.startup.trim() !== '')
        .forEach(item => {
            stages[item.stage] = (stages[item.stage] || 0) + 1;
        });
    
    const processedStages = processChartData(stages, 5);
    stageChart.data.labels = Object.keys(processedStages);
    stageChart.data.datasets[0].data = Object.values(processedStages);
    stageChart.update();

    // Update country chart
    const countries = {};
    filteredData
        .filter(item => item.startup && item.startup.trim() !== '')
        .forEach(item => {
            countries[item.country] = (countries[item.country] || 0) + 1;
        });
    
    const processedCountries = processChartData(countries, 5);
    countryChart.data.labels = Object.keys(processedCountries);
    countryChart.data.datasets[0].data = Object.values(processedCountries);
    countryChart.update();
}

function updateReportsTable(filteredData) {
    const reportsTableBody = document.getElementById('reportsTableBody');
    reportsTableBody.innerHTML = '';

    const selectedPartner = document.getElementById('partnerFilter').value;

    const reportSummary = {};
    data
        .filter(item => 
            item.quarter !== 'Engagement Activity' && 
            item.quarter !== 'Matched Startup' &&
            (selectedPartner === 'all' || item.partner === selectedPartner)
        )
        .forEach(item => {
            const key = `${item.quarter}-${item.partner}-${item.date}`;
            if (!reportSummary[key]) {
                reportSummary[key] = {
                    report: item.quarter,
                    partner: item.partner,
                    date: item.date,
                    count: 0,
                    comments: ''
                };
            }
            
            // Only count items with non-empty startup names
            if (item.startup && item.startup.trim() !== '') {
                reportSummary[key].count++;
            }
            
            // Add comments for rows with no startup or where engaged is 'no'
            if ((!item.startup || item.startup.trim() === '' || item.engaged?.toLowerCase() === 'no') 
                && item.comments && item.comments.trim() !== '') {
                reportSummary[key].comments = item.comments;
            }
        });

    Object.values(reportSummary)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .forEach(report => {
            const row = reportsTableBody.insertRow();
            row.insertCell(0).textContent = report.report;
            row.insertCell(1).textContent = report.partner;
            row.insertCell(2).textContent = report.date;
            row.insertCell(3).textContent = report.count === 0 ? "-" : report.count;
            const descCell = row.insertCell(4);
            descCell.textContent = report.comments;
            descCell.className = 'description';
        });
}

function updateActivitiesTable() {
    const tableBody = document.getElementById('activitiesTableBody');
    tableBody.innerHTML = '';
    
    const selectedPartner = document.getElementById('partnerFilter').value;
    
    const activitiesData = data
        .filter(item => 
            item.quarter === 'Engagement Activity' &&
            (selectedPartner === 'all' || item.partner === selectedPartner)
        )
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    activitiesData.forEach(item => {
        const row = tableBody.insertRow();
        const activityCell = row.insertCell(0);
        const partnerCell = row.insertCell(1);
        const dateCell = row.insertCell(2);
        const descCell = row.insertCell(3);
        
        activityCell.textContent = item.engagement;
        partnerCell.textContent = item.partner;
        dateCell.textContent = item.date;
        descCell.textContent = item.comments || '';
        descCell.className = 'description';
    });

    document.getElementById('totalActivities').textContent = activitiesData.length;
}
        function showReportsModal() {
            document.getElementById('reportsModal').style.display = 'flex';
        }

        function hideReportsModal() {
            document.getElementById('reportsModal').style.display = 'none';
        }

        function showActivitiesModal() {
            document.getElementById('activitiesModal').style.display = 'flex';
            updateActivitiesTable();
        }

        function hideActivitiesModal() {
            document.getElementById('activitiesModal').style.display = 'none';
        }

        // Add event listeners for filters
        document.getElementById('partnerFilter').addEventListener('change', updateDashboard);
        document.getElementById('reportFilter').addEventListener('change', updateDashboard);

        // Close modal when clicking outside
        window.onclick = function(event) {
            const reportsModal = document.getElementById('reportsModal');
            const activitiesModal = document.getElementById('activitiesModal');
            if (event.target === reportsModal) {
                hideReportsModal();
            }
            if (event.target === activitiesModal) {
                hideActivitiesModal();
            }
        }
    </script>
</body>
</html>